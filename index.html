<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>App de Contas - Controle Financeiro</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Controle suas finan√ßas de forma simples e eficiente. Gerencie receitas, gastos, contas priorit√°rias e d√≠zimo.">
    <meta name="keywords" content="finan√ßas, contas, receitas, gastos, d√≠zimo, controle financeiro, PWA">
    <meta name="author" content="App de Contas">
    <meta name="robots" content="index, follow">
    
    <!-- PWA Theme -->
    <meta name="theme-color" content="#3b82f6">
    <meta name="msapplication-TileColor" content="#3b82f6">
    <meta name="msapplication-navbutton-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="App Contas">
    
    <!-- PWA Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMTMuMDkgOC4yNkwyMCA5TDEzLjA5IDE1Ljc0TDEyIDIyTDEwLjkxIDE1Ljc0TDQgOUwxMC45MSA4LjI2TDEyIDJaIiBmaWxsPSIjZjU5ZTAiLz4KPC9zdmc+">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cGF0aCBkPSJNMTIgMkwxMy4wOSA4LjI2TDIwIDlMMTMuMDkgMTUuNzRMMTIgMjJMMTAuOTEgMTUuNzRMNCA5TDEwLjkxIDguMjZMMTIgMloiIGZpbGw9IiNmNTllMCIvPgo8L3N2Zz4K">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="dns-prefetch" href="https://cdn.tailwindcss.com">
    
    <!-- PWA Configuration -->
    <script src="/pwa-config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#3B82F6',
                        'success': '#10B981',
                        'danger': '#EF4444',
                        'warning': '#F59E0B'
                    },
                    screens: {
                        'xs': '475px',
                        'sm': '640px',
                        'md': '768px',
                        'lg': '1024px',
                        'xl': '1280px',
                        '2xl': '1536px',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Firefox scrollbar */
        * {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }
        
        /* Hover effects */
        .btn-receita:hover {
            background-color: #059669;
            transform: translateY(-1px);
        }
        
        .btn-gasto:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
        }
        
        /* Smooth transitions */
        * {
            transition: all 0.2s ease;
        }
        
        /* Responsive adjustments */
        @media (max-width: 640px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }
        
        /* Full height for mobile */
        html, body {
            height: 100%;
            min-height: 100vh;
            min-height: 100dvh;
        }
        
        /* Better mobile spacing */
        @media (max-width: 480px) {
            .grid-cols-2 {
                gap: 0.75rem;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen w-full">
    <!-- PWA Status Bar -->
    <div id="pwa-status-bar" class="hidden fixed top-0 left-0 right-0 bg-blue-500 text-white text-center py-1 text-xs z-50">
        <span id="pwa-status-text">PWA carregando...</span>
    </div>

    <div class="container mx-auto px-3 sm:px-4 py-4 sm:py-6 max-w-4xl w-full">
        <!-- Header -->
        <div class="text-center mb-6 sm:mb-8">
            <div class="w-10 h-10 sm:w-12 sm:h-12 bg-yellow-400 rounded-full flex items-center justify-center shadow-lg mx-auto mb-3 sm:mb-4">
                <span class="text-xl sm:text-2xl">üí∞</span>
            </div>
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-2">Controle de gastos</h1>
            <p class="text-sm sm:text-base text-gray-600">Controle suas finan√ßas de forma simples</p>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-2 gap-3 sm:gap-4 mb-6 sm:mb-8">
            <!-- Receitas -->
            <div class="bg-white rounded-lg sm:rounded-xl p-3 sm:p-4 shadow-lg border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div class="min-w-0 flex-1">
                        <p class="text-xs sm:text-sm text-gray-600 truncate">Receitas</p>
                        <p class="text-lg sm:text-xl lg:text-2xl font-bold text-green-600 truncate" id="total-receitas">R$ 0,00</p>
                    </div>
                    <div class="w-8 h-8 sm:w-10 sm:h-10 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0 ml-2">
                        <span class="text-green-600 text-sm sm:text-base lg:text-xl">üìà</span>
                    </div>
                </div>
            </div>

            <!-- Gastos -->
            <div class="bg-white rounded-lg sm:rounded-xl p-3 sm:p-4 shadow-lg border-l-4 border-red-500">
                <div class="flex items-center justify-between">
                    <div class="min-w-0 flex-1">
                        <p class="text-xs sm:text-sm text-gray-600 truncate">Gastos</p>
                        <p class="text-lg sm:text-xl lg:text-2xl font-bold text-red-600 truncate" id="total-gastos">R$ 0,00</p>
                    </div>
                    <div class="w-8 h-8 sm:w-10 sm:h-10 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0 ml-2">
                        <span class="text-red-600 text-sm sm:text-base lg:text-xl">üìâ</span>
                    </div>
                </div>
            </div>

            <!-- Saldo -->
            <div class="bg-white rounded-lg sm:rounded-xl p-3 sm:p-4 shadow-lg border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div class="min-w-0 flex-1">
                        <p class="text-xs sm:text-sm text-gray-600 truncate">Saldo</p>
                        <p class="text-lg sm:text-xl lg:text-2xl font-bold text-blue-600 truncate" id="saldo-atual">R$ 0,00</p>
                    </div>
                    <div class="w-8 h-8 sm:w-10 sm:h-10 bg-blue-100 rounded-full flex items-center justify-center flex-shrink-0 ml-2">
                        <span class="text-blue-600 text-sm sm:text-base lg:text-xl">üí≥</span>
                    </div>
                </div>
            </div>

            <!-- D√≠zimo -->
            <div class="bg-white rounded-lg sm:rounded-xl p-3 sm:p-4 shadow-lg border-l-4 border-yellow-500">
                <div class="flex items-center justify-between">
                    <div class="min-w-0 flex-1">
                        <p class="text-xs sm:text-sm text-gray-600 truncate">D√≠zimo (10%)</p>
                        <p class="text-lg sm:text-xl lg:text-2xl font-bold text-yellow-600 truncate" id="total-dizimo">R$ 0,00</p>
                    </div>
                    <div class="w-8 h-8 sm:w-10 sm:h-10 bg-yellow-100 rounded-full flex items-center justify-center flex-shrink-0 ml-2">
                        <span class="text-yellow-600 text-sm sm:text-base lg:text-xl">‚õ™</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction Form -->
        <div class="bg-white rounded-lg sm:rounded-xl p-4 sm:p-6 shadow-lg mb-6 sm:mb-8">
            <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">Adicionar Transa√ß√£o</h2>
            
            <!-- Transaction Type Toggle -->
            <div class="flex gap-2 mb-4">
                <button id="btn-receita" class="btn-receita flex-1 py-2 sm:py-3 px-3 sm:px-4 rounded-lg font-semibold text-white bg-green-500 hover:bg-green-600 transition-all text-sm sm:text-base">
                    + Receita
                </button>
                <button id="btn-gasto" class="btn-gasto flex-1 py-2 sm:py-3 px-3 sm:px-4 rounded-lg font-semibold text-white bg-red-500 hover:bg-red-600 transition-all text-sm sm:text-base">
                    - Gasto
                </button>
            </div>

            <form id="transaction-form" class="space-y-3 sm:space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1 sm:mb-2">Valor</label>
                    <input type="text" id="valor" class="w-full px-3 sm:px-4 py-2 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base" placeholder="R$ 0,00" inputmode="numeric">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1 sm:mb-2">Descri√ß√£o</label>
                    <input type="text" id="descricao" class="w-full px-3 sm:px-4 py-2 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base" placeholder="Ex: Sal√°rio, Almo√ßo, etc.">
                </div>

                <!-- Category (only for expenses) -->
                <div id="categoria-container" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1 sm:mb-2">Categoria</label>
                    <select id="categoria" class="w-full px-3 sm:px-4 py-2 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm sm:text-base">
                        <option value="">Selecione uma categoria</option>
                        <option value="alimentacao">üçΩÔ∏è Alimenta√ß√£o</option>
                        <option value="transporte">üöó Transporte</option>
                        <option value="saude">üè• Sa√∫de</option>
                        <option value="educacao">üìö Educa√ß√£o</option>
                        <option value="lazer">üéÆ Lazer</option>
                        <option value="vestuario">üëï Vestu√°rio</option>
                        <option value="casa">üè† Casa</option>
                        <option value="servicos">üîß Servi√ßos</option>
                        <option value="outros">üì¶ Outros</option>
                    </select>
                </div>

                <button type="submit" id="submit-btn" class="w-full py-2 sm:py-3 px-4 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition-all text-sm sm:text-base">
                    Adicionar Receita
                </button>
            </form>
        </div>

        <!-- Priority Bills -->
        <div class="bg-white rounded-lg sm:rounded-xl p-4 sm:p-6 shadow-lg mb-6 sm:mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg sm:text-xl font-bold text-gray-800">Contas Priorit√°rias</h2>
                <button id="add-bill-btn" class="bg-blue-500 text-white px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg hover:bg-blue-600 transition-all text-sm sm:text-base">
                    + Adicionar
                </button>
            </div>

            <!-- Add Bill Form -->
            <div id="add-bill-form" class="hidden mb-4 sm:mb-6 p-3 sm:p-4 bg-gray-50 rounded-lg">
                <h3 class="font-semibold text-gray-800 mb-3 text-sm sm:text-base">Nova Conta Priorit√°ria</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                    <div class="sm:col-span-2 lg:col-span-1">
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Nome da Conta</label>
                        <input type="text" id="nome-conta" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm" placeholder="Ex: Aluguel">
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Valor</label>
                        <input type="text" id="valor-conta" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm" placeholder="R$ 0,00" inputmode="numeric">
                    </div>
                    <div>
                        <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-1">Data de Vencimento</label>
                        <input type="date" id="data-vencimento" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                    </div>
                </div>
                <div class="flex gap-2 mt-3 sm:mt-4">
                    <button id="save-bill-btn" class="bg-green-500 text-white px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg hover:bg-green-600 transition-all text-sm">
                        Salvar
                    </button>
                    <button id="cancel-bill-btn" class="bg-gray-500 text-white px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg hover:bg-gray-600 transition-all text-sm">
                        Cancelar
                    </button>
                </div>
            </div>

            <!-- Bills List -->
            <div id="bills-list" class="space-y-2 sm:space-y-3">
                <!-- Bills will be dynamically added here -->
            </div>
        </div>

        <!-- Expense Reports -->
        <div class="bg-white rounded-lg sm:rounded-xl p-4 sm:p-6 shadow-lg mb-6 sm:mb-8">
            <h2 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">üìä Relat√≥rio de Gastos por Categoria</h2>
            <div id="expense-reports" class="space-y-3">
                <!-- Reports will be dynamically added here -->
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="bg-white rounded-lg sm:rounded-xl p-4 sm:p-6 shadow-lg">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4 gap-2 sm:gap-0">
                <h2 class="text-lg sm:text-xl font-bold text-gray-800">Transa√ß√µes Recentes</h2>
                <div class="flex flex-wrap gap-2">
                    <button id="clear-income-btn" class="bg-red-500 text-white px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg hover:bg-red-600 transition-all text-sm sm:text-base">
                        Limpar Receitas
                    </button>
                    <button id="clear-expenses-btn" class="bg-orange-500 text-white px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg hover:bg-orange-600 transition-all text-sm sm:text-base">
                        Limpar Gastos
                    </button>
                </div>
            </div>
            <div id="transactions-list" class="space-y-2 sm:space-y-3">
                <!-- Transactions will be dynamically added here -->
            </div>
        </div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="import-file" accept=".json" style="display: none;" onchange="handleImport(event)">

    <script>
        // Global variables
        let currentTransactionType = 'receita';
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let priorityBills = JSON.parse(localStorage.getItem('priorityBills')) || [];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            updateDisplay();
            initializePWA();
            showPWAStatus();
        });

        function initializeApp() {
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('data-vencimento').value = today;
        }

        function setupEventListeners() {
            // Transaction type buttons
            document.getElementById('btn-receita').addEventListener('click', () => setTransactionType('receita'));
            document.getElementById('btn-gasto').addEventListener('click', () => setTransactionType('gasto'));

            // Transaction form
            document.getElementById('transaction-form').addEventListener('submit', handleTransactionSubmit);

            // Priority bills
            document.getElementById('add-bill-btn').addEventListener('click', toggleAddBillForm);
            document.getElementById('save-bill-btn').addEventListener('click', savePriorityBill);
            document.getElementById('cancel-bill-btn').addEventListener('click', toggleAddBillForm);

            // Clear income button
            document.getElementById('clear-income-btn').addEventListener('click', clearIncome);
            
            // Clear expenses button
            document.getElementById('clear-expenses-btn').addEventListener('click', clearExpenses);

            // Currency mask for transaction value
            document.getElementById('valor').addEventListener('input', applyCurrencyMask);
            document.getElementById('valor-conta').addEventListener('input', applyCurrencyMask);
        }

        function setTransactionType(type) {
            currentTransactionType = type;
            
            // Update button styles
            const receitaBtn = document.getElementById('btn-receita');
            const gastoBtn = document.getElementById('btn-gasto');
            const submitBtn = document.getElementById('submit-btn');
            const categoriaContainer = document.getElementById('categoria-container');

            // Verificar se h√° receitas
            const receitas = transactions.filter(t => t.tipo === 'receita').reduce((sum, t) => sum + t.valor, 0);
            const podeGastar = receitas > 0;

            if (type === 'receita') {
                receitaBtn.classList.add('bg-green-600');
                receitaBtn.classList.remove('bg-green-500');
                gastoBtn.classList.add('bg-red-500');
                gastoBtn.classList.remove('bg-red-600');
                submitBtn.textContent = 'Adicionar Receita';
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                categoriaContainer.classList.add('hidden');
            } else {
                receitaBtn.classList.add('bg-green-500');
                receitaBtn.classList.remove('bg-green-600');
                
                if (podeGastar) {
                    gastoBtn.classList.add('bg-red-600');
                    gastoBtn.classList.remove('bg-red-500');
                    submitBtn.textContent = 'Adicionar Gasto';
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    gastoBtn.classList.add('bg-gray-400');
                    gastoBtn.classList.remove('bg-red-500', 'bg-red-600');
                    submitBtn.textContent = 'Adicionar Receita Primeiro';
                    submitBtn.disabled = true;
                    submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
                
                categoriaContainer.classList.remove('hidden');
            }
        }

        function applyCurrencyMask(event) {
            let value = event.target.value.replace(/\D/g, '');
            if (value === '') {
                event.target.value = '';
                return;
            }
            
            // Convert to currency format
            const numericValue = parseInt(value) / 100;
            event.target.value = numericValue.toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
        }

        function handleTransactionSubmit(event) {
            event.preventDefault();
            
            const valor = document.getElementById('valor').value;
            const descricao = document.getElementById('descricao').value;
            const categoria = document.getElementById('categoria').value;

            if (!valor || !descricao) {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }

            // Parse currency value
            const numericValue = parseFloat(valor.replace(/[^\d,]/g, '').replace(',', '.'));

            // Se for gasto, verificar se h√° receitas
            if (currentTransactionType === 'gasto') {
                const receitas = transactions.filter(t => t.tipo === 'receita').reduce((sum, t) => sum + t.valor, 0);
                const gastos = transactions.filter(t => t.tipo === 'gasto').reduce((sum, t) => sum + t.valor, 0);
                const dizimo = receitas * 0.10;
                const saldoDisponivel = receitas - gastos - dizimo;
                
                if (receitas === 0) {
                    alert('‚ùå N√£o √© poss√≠vel adicionar gastos sem receitas!\n\nAdicione receitas primeiro para poder fazer gastos.');
                    return;
                }
                
                if (saldoDisponivel < numericValue) {
                    alert(`‚ùå Saldo insuficiente!\n\nVoc√™ tem R$ ${formatCurrency(saldoDisponivel)} dispon√≠vel, mas est√° tentando gastar R$ ${formatCurrency(numericValue)}.`);
                    return;
                }
            }

            const transaction = {
                id: Date.now(),
                tipo: currentTransactionType,
                valor: numericValue,
                descricao: descricao,
                categoria: categoria || null,
                data: new Date().toISOString()
            };

            transactions.unshift(transaction);
            localStorage.setItem('transactions', JSON.stringify(transactions));
            
            // Clear form
            document.getElementById('valor').value = '';
            document.getElementById('descricao').value = '';
            document.getElementById('categoria').value = '';
            
            updateDisplay();
        }

        function toggleAddBillForm() {
            const form = document.getElementById('add-bill-form');
            form.classList.toggle('hidden');
        }

        function savePriorityBill() {
            const nome = document.getElementById('nome-conta').value;
            const valor = document.getElementById('valor-conta').value;
            const dataVencimento = document.getElementById('data-vencimento').value;

            if (!nome || !valor || !dataVencimento) {
                alert('Por favor, preencha todos os campos.');
                return;
            }

            // Parse currency value
            const numericValue = parseFloat(valor.replace(/[^\d,]/g, '').replace(',', '.'));

            const bill = {
                id: Date.now(),
                nome: nome,
                valor: numericValue,
                data_vencimento: dataVencimento,
                paga: false
            };

            priorityBills.unshift(bill);
            localStorage.setItem('priorityBills', JSON.stringify(priorityBills));
            
            // Clear form
            document.getElementById('nome-conta').value = '';
            document.getElementById('valor-conta').value = '';
            document.getElementById('data-vencimento').value = new Date().toISOString().split('T')[0];
            
            toggleAddBillForm();
            updateDisplay();
        }

        function markBillAsPaid(billId) {
            const bill = priorityBills.find(b => b.id === billId);
            if (bill) {
                // Se est√° marcando como paga
                if (!bill.paga) {
                    // Calcular receitas dispon√≠veis
                    const receitas = transactions.filter(t => t.tipo === 'receita').reduce((sum, t) => sum + t.valor, 0);
                    const gastos = transactions.filter(t => t.tipo === 'gasto').reduce((sum, t) => sum + t.valor, 0);
                    const dizimo = receitas * 0.10;
                    const saldoDisponivel = receitas - gastos - dizimo;
                    
                    // Verificar se h√° saldo suficiente
                    if (saldoDisponivel < bill.valor) {
                        alert(`Saldo insuficiente! Voc√™ tem R$ ${formatCurrency(saldoDisponivel)} dispon√≠vel, mas a conta custa R$ ${formatCurrency(bill.valor)}.`);
                        return;
                    }
                    
                    // Confirmar pagamento
                    if (!confirm(`Confirmar pagamento de R$ ${formatCurrency(bill.valor)} para "${bill.nome}"?`)) {
                        return;
                    }
                    
                    // Adicionar gasto autom√°tico com refer√™ncia √† conta
                    const gastoAutomatico = {
                        id: Date.now(),
                        tipo: 'gasto',
                        valor: bill.valor,
                        descricao: `Pagamento: ${bill.nome}`,
                        categoria: 'servicos',
                        data: new Date().toISOString(),
                        billId: billId // Refer√™ncia para poder remover depois
                    };
                    
                    transactions.unshift(gastoAutomatico);
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                } else {
                    // Se est√° desmarcando como paga, remover o gasto correspondente
                    const gastoIndex = transactions.findIndex(t => 
                        t.tipo === 'gasto' && 
                        t.descricao === `Pagamento: ${bill.nome}` && 
                        t.billId === billId
                    );
                    
                    if (gastoIndex !== -1) {
                        // Confirmar desmarca√ß√£o
                        if (!confirm(`Desmarcar pagamento de R$ ${formatCurrency(bill.valor)} para "${bill.nome}"? O valor voltar√° para o saldo.`)) {
                            return;
                        }
                        
                        // Remover o gasto
                        transactions.splice(gastoIndex, 1);
                        localStorage.setItem('transactions', JSON.stringify(transactions));
                    }
                }
                
                // Marcar como paga/n√£o paga
                bill.paga = !bill.paga;
                localStorage.setItem('priorityBills', JSON.stringify(priorityBills));
                updateDisplay();
            }
        }

        function deleteBill(billId) {
            const bill = priorityBills.find(b => b.id === billId);
            if (bill) {
                if (confirm('Tem certeza que deseja excluir esta conta?')) {
                    // Se a conta est√° marcada como paga, remover o gasto correspondente
                    if (bill.paga) {
                        const gastoIndex = transactions.findIndex(t => 
                            t.tipo === 'gasto' && 
                            t.descricao === `Pagamento: ${bill.nome}` && 
                            t.billId === billId
                        );
                        
                        if (gastoIndex !== -1) {
                            transactions.splice(gastoIndex, 1);
                            localStorage.setItem('transactions', JSON.stringify(transactions));
                        }
                    }
                    
                    // Remover a conta
                    priorityBills = priorityBills.filter(b => b.id !== billId);
                    localStorage.setItem('priorityBills', JSON.stringify(priorityBills));
                    updateDisplay();
                }
            }
        }

        function clearIncome() {
            if (confirm('Tem certeza que deseja limpar todas as receitas?')) {
                transactions = transactions.filter(t => t.tipo !== 'receita');
                localStorage.setItem('transactions', JSON.stringify(transactions));
                updateDisplay();
            }
        }

        function clearExpenses() {
            if (confirm('Tem certeza que deseja limpar todos os gastos?')) {
                transactions = transactions.filter(t => t.tipo !== 'gasto');
                localStorage.setItem('transactions', JSON.stringify(transactions));
                updateDisplay();
            }
        }

        function updateDisplay() {
            updateSummaryCards();
            updateTransactionsList();
            updateBillsList();
            updateExpenseReports();
            updateTransactionButtons();
        }

        function updateSummaryCards() {
            const receitas = transactions.filter(t => t.tipo === 'receita').reduce((sum, t) => sum + t.valor, 0);
            const gastos = transactions.filter(t => t.tipo === 'gasto').reduce((sum, t) => sum + t.valor, 0);
            const dizimo = receitas * 0.10;
            const saldo = receitas - gastos - dizimo;

            document.getElementById('total-receitas').textContent = formatCurrency(receitas);
            document.getElementById('total-gastos').textContent = formatCurrency(gastos);
            document.getElementById('total-dizimo').textContent = formatCurrency(dizimo);
            document.getElementById('saldo-atual').textContent = formatCurrency(saldo);
        }

        function updateTransactionsList() {
            const container = document.getElementById('transactions-list');
            container.innerHTML = '';

            if (transactions.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhuma transa√ß√£o encontrada.</p>';
                return;
            }

            transactions.slice(0, 10).forEach(transaction => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 sm:p-3 bg-gray-50 rounded-lg';
                
                const isReceita = transaction.tipo === 'receita';
                const icon = isReceita ? 'üìà' : 'üìâ';
                const color = isReceita ? 'text-green-600' : 'text-red-600';
                const bgColor = isReceita ? 'bg-green-100' : 'bg-red-100';
                
                div.innerHTML = `
                    <div class="flex items-center space-x-2 sm:space-x-3 min-w-0 flex-1">
                        <div class="w-6 h-6 sm:w-8 sm:h-8 ${bgColor} rounded-full flex items-center justify-center flex-shrink-0">
                            <span class="text-xs sm:text-sm">${icon}</span>
                        </div>
                        <div class="min-w-0 flex-1">
                            <p class="font-medium text-gray-800 text-sm sm:text-base truncate">${transaction.descricao}</p>
                            <p class="text-xs sm:text-sm text-gray-500">${formatDate(transaction.data)}</p>
                            ${transaction.categoria ? `<p class="text-xs text-slate-400 mt-1 truncate">${getCategoryName(transaction.categoria)}</p>` : ''}
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0 ml-2">
                        <p class="font-bold ${color} text-sm sm:text-base">${isReceita ? '+' : '-'}${formatCurrency(transaction.valor)}</p>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        function updateBillsList() {
            const container = document.getElementById('bills-list');
            container.innerHTML = '';

            if (priorityBills.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhuma conta priorit√°ria encontrada.</p>';
                return;
            }

            priorityBills.forEach(bill => {
                const div = document.createElement('div');
                div.className = `flex flex-col sm:flex-row sm:items-center justify-between p-2 sm:p-3 rounded-lg gap-2 sm:gap-0 ${bill.paga ? 'bg-green-50 border border-green-200' : 'bg-gray-50'}`;
                
                const statusIcon = bill.paga ? '‚úÖ' : '‚è∞';
                const statusText = bill.paga ? 'Paga' : 'Pendente';
                const statusColor = bill.paga ? 'text-green-600' : 'text-yellow-600';
                
                // Verificar se pode pagar (saldo suficiente)
                const receitas = transactions.filter(t => t.tipo === 'receita').reduce((sum, t) => sum + t.valor, 0);
                const gastos = transactions.filter(t => t.tipo === 'gasto').reduce((sum, t) => sum + t.valor, 0);
                const dizimo = receitas * 0.10;
                const saldoDisponivel = receitas - gastos - dizimo;
                const podePagar = saldoDisponivel >= bill.valor;
                
                div.innerHTML = `
                    <div class="flex items-center space-x-2 sm:space-x-3 min-w-0 flex-1">
                        <div class="w-6 h-6 sm:w-8 sm:h-8 bg-white rounded-full flex items-center justify-center flex-shrink-0">
                            <span class="text-xs sm:text-sm">${statusIcon}</span>
                        </div>
                        <div class="min-w-0 flex-1">
                            <p class="font-medium text-gray-800 text-sm sm:text-base truncate">${bill.nome}</p>
                            <p class="text-xs sm:text-sm text-gray-500">Vence: ${formatDate(bill.data_vencimento)}</p>
                            <p class="text-xs ${statusColor}">${statusText}</p>
                            ${!bill.paga && !podePagar ? '<p class="text-xs text-red-500">üí∞ Saldo insuficiente</p>' : ''}
                        </div>
                    </div>
                    <div class="flex items-center justify-between sm:justify-end space-x-2 sm:space-x-2">
                        <p class="font-bold text-gray-800 text-sm sm:text-base">${formatCurrency(bill.valor)}</p>
                        <div class="flex space-x-1">
                            <button onclick="markBillAsPaid(${bill.id})" 
                                    class="px-2 sm:px-3 py-1 text-white text-xs rounded transition-all whitespace-nowrap ${bill.paga ? 'bg-gray-500 hover:bg-gray-600' : podePagar ? 'bg-green-500 hover:bg-green-600' : 'bg-gray-400 cursor-not-allowed'}" 
                                    ${!bill.paga && !podePagar ? 'disabled' : ''}>
                                ${bill.paga ? 'Desmarcar' : 'Pagar'}
                            </button>
                            <button onclick="deleteBill(${bill.id})" class="px-2 sm:px-3 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 transition-all">
                                Excluir
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        function updateExpenseReports() {
            const container = document.getElementById('expense-reports');
            container.innerHTML = '';

            // Calcular gastos por categoria
            const gastosPorCategoria = {};
            const gastos = transactions.filter(t => t.tipo === 'gasto');
            
            gastos.forEach(gasto => {
                const categoria = gasto.categoria || 'outros';
                if (!gastosPorCategoria[categoria]) {
                    gastosPorCategoria[categoria] = 0;
                }
                gastosPorCategoria[categoria] += gasto.valor;
            });

            // Se n√£o h√° gastos, mostrar mensagem
            if (Object.keys(gastosPorCategoria).length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">Nenhum gasto por categoria encontrado.</p>';
                return;
            }

            // Ordenar categorias por valor (maior para menor)
            const categoriasOrdenadas = Object.entries(gastosPorCategoria)
                .sort(([,a], [,b]) => b - a);

            // Calcular total de gastos
            const totalGastos = categoriasOrdenadas.reduce((sum, [, valor]) => sum + valor, 0);

            categoriasOrdenadas.forEach(([categoria, valor]) => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 rounded-lg p-3 sm:p-4';
                
                const percentual = totalGastos > 0 ? (valor / totalGastos) * 100 : 0;
                const nomeCategoria = getCategoryName(categoria);
                const corCategoria = getCategoryColor(categoria);
                
                div.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center space-x-2">
                            <span class="text-lg">${nomeCategoria.split(' ')[0]}</span>
                            <span class="text-sm text-gray-600">${nomeCategoria.split(' ').slice(1).join(' ')}</span>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-gray-800 text-sm sm:text-base">${formatCurrency(valor)}</p>
                            <p class="text-xs text-gray-500">${percentual.toFixed(1)}% do total</p>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="h-2 rounded-full ${corCategoria}" style="width: ${percentual}%"></div>
                    </div>
                `;
                
                container.appendChild(div);
            });

            // Adicionar resumo total
            const resumoDiv = document.createElement('div');
            resumoDiv.className = 'bg-blue-50 border border-blue-200 rounded-lg p-3 sm:p-4 mt-4';
            resumoDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <span class="text-lg">üìä</span>
                        <span class="font-semibold text-blue-800">Total de Gastos</span>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-blue-800 text-lg">${formatCurrency(totalGastos)}</p>
                        <p class="text-xs text-blue-600">${categoriasOrdenadas.length} categorias</p>
                    </div>
                </div>
            `;
            
            container.appendChild(resumoDiv);
        }

        function updateTransactionButtons() {
            // Verificar se h√° receitas
            const receitas = transactions.filter(t => t.tipo === 'receita').reduce((sum, t) => sum + t.valor, 0);
            const podeGastar = receitas > 0;
            
            const gastoBtn = document.getElementById('btn-gasto');
            const submitBtn = document.getElementById('submit-btn');
            
            // Se o tipo atual √© gasto, atualizar o estado dos bot√µes
            if (currentTransactionType === 'gasto') {
                if (podeGastar) {
                    gastoBtn.classList.add('bg-red-600');
                    gastoBtn.classList.remove('bg-gray-400');
                    submitBtn.textContent = 'Adicionar Gasto';
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                } else {
                    gastoBtn.classList.add('bg-gray-400');
                    gastoBtn.classList.remove('bg-red-600');
                    submitBtn.textContent = 'Adicionar Receita Primeiro';
                    submitBtn.disabled = true;
                    submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }
        }

        function formatCurrency(value) {
            return value.toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        function getCategoryName(category) {
            const categories = {
                'alimentacao': 'üçΩÔ∏è Alimenta√ß√£o',
                'transporte': 'üöó Transporte',
                'saude': 'üè• Sa√∫de',
                'educacao': 'üìö Educa√ß√£o',
                'lazer': 'üéÆ Lazer',
                'vestuario': 'üëï Vestu√°rio',
                'casa': 'üè† Casa',
                'servicos': 'üîß Servi√ßos',
                'outros': 'üì¶ Outros'
            };
            return categories[category] || category;
        }

        function getCategoryColor(category) {
            const colors = {
                'alimentacao': 'bg-orange-500',
                'transporte': 'bg-blue-500',
                'saude': 'bg-red-500',
                'educacao': 'bg-purple-500',
                'lazer': 'bg-green-500',
                'vestuario': 'bg-pink-500',
                'casa': 'bg-yellow-500',
                'servicos': 'bg-indigo-500',
                'outros': 'bg-gray-500'
            };
            return colors[category] || 'bg-gray-500';
        }

        // PWA Functions
        function initializePWA() {
            // Register Service Worker
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js')
                        .then((registration) => {
                            console.log('SW registered: ', registration);
                            
                            // Check for updates
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        showUpdateNotification();
                                    }
                                });
                            });
                        })
                        .catch((registrationError) => {
                            console.log('SW registration failed: ', registrationError);
                        });
                });
            }

            // Handle PWA install prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                console.log('PWA install prompt triggered');
                e.preventDefault();
                deferredPrompt = e;
                showInstallButton();
            });

            // Handle PWA installed
            window.addEventListener('appinstalled', (evt) => {
                console.log('PWA was installed');
                hideInstallButton();
            });

            // Handle online/offline status
            window.addEventListener('online', () => {
                console.log('App is online');
                showOnlineStatus();
            });

            window.addEventListener('offline', () => {
                console.log('App is offline');
                showOfflineStatus();
            });

            // Handle URL shortcuts
            handleURLShortcuts();
        }

        function showInstallButton() {
            // Create install button if it doesn't exist
            if (!document.getElementById('install-button')) {
                const installBtn = document.createElement('button');
                installBtn.id = 'install-button';
                installBtn.className = 'fixed bottom-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-full shadow-lg hover:bg-blue-600 transition-all z-50';
                installBtn.innerHTML = 'üì± Instalar App';
                installBtn.onclick = installPWA;
                document.body.appendChild(installBtn);
            }
        }

        function hideInstallButton() {
            const installBtn = document.getElementById('install-button');
            if (installBtn) {
                installBtn.remove();
            }
        }

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    } else {
                        console.log('User dismissed the install prompt');
                    }
                    deferredPrompt = null;
                    hideInstallButton();
                });
            }
        }

        function showUpdateNotification() {
            // Create update notification
            const updateNotification = document.createElement('div');
            updateNotification.className = 'fixed top-4 left-4 right-4 bg-green-500 text-white p-3 rounded-lg shadow-lg z-50';
            updateNotification.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>üîÑ Nova vers√£o dispon√≠vel!</span>
                    <button onclick="updateApp()" class="bg-white text-green-500 px-3 py-1 rounded text-sm font-semibold">
                        Atualizar
                    </button>
                </div>
            `;
            document.body.appendChild(updateNotification);

            // Auto remove after 10 seconds
            setTimeout(() => {
                if (updateNotification.parentNode) {
                    updateNotification.remove();
                }
            }, 10000);
        }

        function updateApp() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistration().then((registration) => {
                    if (registration && registration.waiting) {
                        registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                        window.location.reload();
                    }
                });
            }
        }

        function showOnlineStatus() {
            const status = document.getElementById('connection-status');
            if (status) {
                status.textContent = 'üü¢ Online';
                status.className = 'fixed top-2 right-2 bg-green-500 text-white px-2 py-1 rounded text-xs z-50';
            }
        }

        function showOfflineStatus() {
            const status = document.getElementById('connection-status');
            if (status) {
                status.textContent = 'üî¥ Offline';
                status.className = 'fixed top-2 right-2 bg-red-500 text-white px-2 py-1 rounded text-xs z-50';
            }
        }

        function handleURLShortcuts() {
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            
            if (action === 'add-income') {
                setTransactionType('receita');
                document.getElementById('valor').focus();
            } else if (action === 'add-expense') {
                setTransactionType('gasto');
                document.getElementById('valor').focus();
            }
        }

        // PWA Status functions
        function showPWAStatus() {
            const statusBar = document.getElementById('pwa-status-bar');
            const statusText = document.getElementById('pwa-status-text');
            
            if (window.pwaConfig) {
                const appInfo = window.pwaConfig.getAppInfo();
                if (appInfo.installed) {
                    statusText.textContent = 'üì± App instalado ‚Ä¢ PWA ativo';
                    statusBar.className = 'fixed top-0 left-0 right-0 bg-green-500 text-white text-center py-1 text-xs z-50';
                } else {
                    statusText.textContent = 'üåê PWA dispon√≠vel ‚Ä¢ Toque para instalar';
                    statusBar.className = 'fixed top-0 left-0 right-0 bg-blue-500 text-white text-center py-1 text-xs z-50 cursor-pointer';
                    statusBar.onclick = () => window.pwaConfig.installPWA();
                }
                statusBar.classList.remove('hidden');
                
                // Hide after 5 seconds
                setTimeout(() => {
                    statusBar.classList.add('hidden');
                }, 5000);
            }
        }

        // Import function
        function handleImport(event) {
            const file = event.target.files[0];
            if (file) {
                if (window.pwaConfig) {
                    window.pwaConfig.importData(file)
                        .then((data) => {
                            transactions = data.transactions;
                            priorityBills = data.priorityBills;
                            localStorage.setItem('transactions', JSON.stringify(transactions));
                            localStorage.setItem('priorityBills', JSON.stringify(priorityBills));
                            updateDisplay();
                            alert('‚úÖ Dados importados com sucesso!');
                        })
                        .catch((error) => {
                            alert('‚ùå Erro ao importar dados: ' + error.message);
                        });
                } else {
                    // Fallback import
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.transactions && data.priorityBills) {
                                transactions = data.transactions;
                                priorityBills = data.priorityBills;
                                localStorage.setItem('transactions', JSON.stringify(transactions));
                                localStorage.setItem('priorityBills', JSON.stringify(priorityBills));
                                updateDisplay();
                                alert('‚úÖ Dados importados com sucesso!');
                            } else {
                                alert('‚ùå Arquivo inv√°lido!');
                            }
                        } catch (error) {
                            alert('‚ùå Erro ao importar dados: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            }
        }

        // Enhanced PWA functions
        function showInstallButton() {
            if (window.pwaConfig) {
                window.pwaConfig.showInstallButton();
            }
        }

        function hideInstallButton() {
            if (window.pwaConfig) {
                window.pwaConfig.hideInstallButton();
            }
        }

        function installPWA() {
            if (window.pwaConfig) {
                window.pwaConfig.installPWA();
            }
        }

        function showUpdateNotification() {
            if (window.pwaConfig) {
                window.pwaConfig.showUpdateNotification();
            }
        }

        function updateApp() {
            if (window.pwaConfig) {
                window.pwaConfig.updateApp();
            }
        }

        function showOnlineStatus() {
            if (window.pwaConfig) {
                window.pwaConfig.showOnlineStatus();
            }
        }

        function showOfflineStatus() {
            if (window.pwaConfig) {
                window.pwaConfig.showOfflineStatus();
            }
        }
    </script>
</body>
</html>
